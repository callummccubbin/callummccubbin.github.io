<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
		<script src="three.js"></script>
        <script type="x-shader/x-vertex" id="vertexShader">

            varying vec3 vWorldPosition;

            void main() {

                vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
                vWorldPosition = worldPosition.xyz;

                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

            }

        </script>
        <script type="x-shader/x-fragment" id="fragmentShader">

			uniform vec3 topColor;
			uniform vec3 bottomColor;
			uniform float offset;
			uniform float exponent;

			varying vec3 vWorldPosition;

			void main() {

				float h = normalize( vWorldPosition + offset ).y;
				gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );

			}

		</script>
		<script>
            const scene = new THREE.Scene();

            const camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 1, 5000 );
            camera.position.set( 0, 9, 20);

            scene.background = new THREE.Color().setHSL( 0.6, 0, 1 );
            scene.fog = new THREE.Fog( scene.background, 1, 5000 );

            const renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshStandardMaterial( { color: 0xa7c330 } );
            const cube = new THREE.Mesh( geometry, material );
            cube.castShadow = true;
            scene.add( cube );

            //LIGHTS

            const hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
            hemiLight.color.setHSL( 0.6, 1, 0.6 );
            hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
            hemiLight.position.set( 0, 10, 0 );
            scene.add( hemiLight );

            // const hemiLightHelper = new THREE.HemisphereLightHelper( hemiLight, 10 );
            // scene.add( hemiLightHelper );

            //

            const dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
            dirLight.color.setHSL( 0.1, 1, 0.95 );
            dirLight.position.set( - 1, 1.75, 1 );
            dirLight.position.multiplyScalar( 30 );
            scene.add( dirLight );

            dirLight.castShadow = true;

            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;

            const d = 50;

            dirLight.shadow.camera.left = - d;
            dirLight.shadow.camera.right = d;
            dirLight.shadow.camera.top = d;
            dirLight.shadow.camera.bottom = - d;

            dirLight.shadow.camera.far = 3500;
            dirLight.shadow.bias = - 0.0001;

            const dirLightHelper = new THREE.DirectionalLightHelper( dirLight, 10 );
            scene.add( dirLightHelper );

            // // GROUND

            const groundGeo = new THREE.PlaneGeometry( 10000, 10000 );
            const groundMat = new THREE.MeshLambertMaterial( { color: 0xffffff } );
            groundMat.color.setHSL( 0.095, 1, 0.75 );

            const ground = new THREE.Mesh( groundGeo, groundMat );
            ground.position.y = -1;
            ground.rotation.x = - Math.PI / 2;
            ground.receiveShadow = true;
            scene.add( ground );

            // // SKYDOME

            const vertexShader = document.getElementById( 'vertexShader' ).textContent;
            const fragmentShader = document.getElementById( 'fragmentShader' ).textContent;
            const uniforms = {
                'topColor': { value: new THREE.Color( 0x0077ff ) },
                'bottomColor': { value: new THREE.Color( 0xffffff ) },
                'offset': { value: 33 },
                'exponent': { value: 0.6 }
            };
            uniforms[ 'topColor' ].value.copy( hemiLight.color );

            scene.fog.color.copy( uniforms[ 'bottomColor' ].value );

            const skyGeo = new THREE.SphereGeometry( 4000, 32, 15 );
            const skyMat = new THREE.ShaderMaterial( {
                uniforms: uniforms,
                vertexShader: vertexShader,
                fragmentShader: fragmentShader,
                side: THREE.BackSide
            } );

            const sky = new THREE.Mesh( skyGeo, skyMat );
            scene.add( sky );

            camera.rotation.x = -.2;
            let r = 10;
            let theta = 0;
			function animate() {
				requestAnimationFrame( animate );
                dirLight.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), 0.01);
                theta += 0.05;
                dirLight.position.x = r * Math.sin(theta);
                dirLight.position.z = r * Math.cos(theta);
    
                cube.position.z -= 0.04;
                cube.rotation.y += 0.01;
				renderer.render( scene, camera );
			};
			animate();
		</script>
	</body>
</html>